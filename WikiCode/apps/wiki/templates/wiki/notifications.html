<!--
    Copyright (C) 2016 Igor Soloduev <diahorver@gmail.com>

    This file is part of WikiCode.

    WikiCode is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    WikiCode is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with WikiCode.  If not, see <http://www.gnu.org/licenses/>.
-->
{% extends 'main.html' %}
{% load bootstrap3 %}
{% block page_name %}
    <div class="container" style="margin-top: 50px;">
        <div class="row">
            <br>
        </div>
    </div>
    <div class="container">
        <div class="row">
        </div>
    </div>
{% endblock %}
{% block content %}
    <div id="main-block" class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-4 col-md-4">
                <div class="row">
                    <a id="a-tree-manager" href="{% url 'tree_manager' %}"><label class="text-center btn-primary btn-block">МОЕ ДЕРЕВО</label></a>
                </div>
                <div class="row">
                    {% if preview_tree == "NONE" %}
                        <div class="col-xs-12 text-center">
                            <label>Дерево отсутствует</label>
                        </div>
                    {% else %}
                        <ul id="tree2">
                            <!--Здесь должен располагаться сгенерированный html preview дерева-->
                            {{ preview_tree|safe }}
                        </ul>
                        <ul id="tree2saved" class="wiki-tree-saved">
                            <!--Здесь должен располагаться сгенерированный html дерева с сохраненными конспектами-->
                            {{ saved_publ|safe }}
                        </ul>
                    {% endif %}
                </div>
            </div>
            <div class="col-xs-12 col-sm-8 col-md-8"
                 style="border-left: 1px solid #d5d5d5;
                 min-height: 250px;">
                <div class="row">
                    <label class="text-center btn-primary btn-block">МОИ УВЕДОМЛЕНИЯ</label>
                </div>
                <div class="container-fluid">
                    <div class="row">
                        <label class="text-left">Фильтры:</label>
                    </div>
                    <div class="row">
                        <label class="text-left"><a class="wiki-filter">Сообщения</a> | <a class="wiki-filter">Ответы</a> | <a class="wiki-filter">Ошибки</a> | <a class="wiki-filter">Заявки</a> | <a class="wiki-filter">Новости</a> | <a class="wiki-filter">События</a> | <a class="wiki-filter">Предупреждения</a> | <a class="wiki-filter">Внимание</a></label>
                    </div>
                    <div class="row">
                        <hr>
                    </div>
                </div>
                <div class="container-fluid">
                    {% if not notifications %}
                        <div class="text-center">
                            <br>
                            <h4>У вас нет ни одного уведомления.</h4>
                            <br>
                        </div>
                    {% endif %}
                    {% for notification in notifications %}
                        <!--Экземпляр уведомления-->
                        {% if notification.type == "message" %}
                            <div id="wiki-notification-{{ notification.number }}" data-toggle="modal" data-target="#modal_notification" class="row notification-li {% if notification.is_read %}read-li{% endif %}">
                                <div class="col-xs-8"><label class="wiki-notification"><i class="fa fa-envelope"></i> | ПИСЬМО ОТ | {{ notification.nickname|upper }} | {{ notification.date }}</label></div>
                                <div class="col-xs-4 text-right"><label>{% if notification.is_read %}(Прочитано){% endif %}</label></div>
                            </div>
                        {% elif notification.type == "sended message" %}
                            <div id="wiki-notification-{{ notification.number }}" data-toggle="modal" data-target="#modal_notification" class="row notification-li {% if notification.is_read %}read-li{% endif %}">
                                <div class="col-xs-8"><label class="wiki-notification"><i class="fa fa-envelope"></i> | ОТПРАВЛЕННОЕ | {{ notification.nickname|upper }} | {{ notification.date }}</label></div>
                                <div class="col-xs-4 text-right"><label></label></div>
                            </div>
                        {% elif notification.type == "invite_colleagues" %}
                            <div id="wiki-notification-{{ notification.number }}" data-toggle="modal" data-target="#modal_notification" class="row notification-li {% if notification.is_read %}read-li{% endif %}">
                                <div class="col-xs-8"><label class="wiki-notification"><i class="glyphicon glyphicon-user"></i> | ЗАЯВКА | {{ notification.nickname|upper }} | {{ notification.date }}</label></div>
                                <div class="col-xs-4 text-right"><label>{% if notification.is_read %}(Прочитано){% endif %}</label></div>
                            </div>
                        {% endif %}
                    {% endfor %}
                    {##}
                    {#                    <!--Экземпляр уведомления-->#}
                    {#                    <div class="row notification-li">#}
                    {#                        <div class="col-xs-8"><label class="wiki-notification"><i class="fa fa-envelope"></i> | СООБЩЕНИЕ | DEV_ADMIN | 13.09.2016</label></div>#}
                    {#                        <div class="col-xs-4 text-right"><label><i class="glyphicon glyphicon-alert problem"></i> <i class="glyphicon glyphicon-remove delete"></i></label></div>#}
                    {#                    </div>#}
                    {##}
                    {#                    <!--Экземпляр уведомления-->#}
                    {#                    <div class="row notification-li read-li">#}
                    {#                        <div class="col-xs-8"><label class="wiki-notification"><i class="glyphicon glyphicon-globe"></i> | НОВОСТИ | DEV_ADMIN | 13.09.2016</label> (Прочитано)</div>#}
                    {#                        <div class="col-xs-4 text-right"><label><i class="glyphicon glyphicon-alert problem"></i> <i class="glyphicon glyphicon-remove delete"></i></label></div>#}
                    {#                    </div>#}
                    {##}
                    {#                    <!--Экземпляр уведомления-->#}
                    {#                    <div class="row notification-li read-li">#}
                    {#                        <div class="col-xs-8"><label class="wiki-notification"><i class="glyphicon glyphicon-user"></i> | ЗАЯВКА | DEV_ADMIN | 13.09.2016</label> (Прочитано)</div>#}
                    {#                        <div class="col-xs-4 text-right"><label><i class="glyphicon glyphicon-alert problem"></i> <i class="glyphicon glyphicon-remove delete"></i></label></div>#}
                    {#                    </div>#}
                    {##}
                    {#                    <!--Экземпляр уведомления-->#}
                    {#                    <div class="row notification-li read-li">#}
                    {#                        <div class="col-xs-8"><label class="wiki-notification"><i class="glyphicon glyphicon-warning-sign"></i> | ОШИБКА | DEV_ADMIN | 13.09.2016</label> (Прочитано)</div>#}
                    {#                        <div class="col-xs-4 text-right"><label><i class="glyphicon glyphicon-alert problem"></i> <i class="glyphicon glyphicon-remove delete"></i></label></div>#}
                    {#                    </div>#}
                    {##}
                    {##}
                    {#                    <!--Экземпляр уведомления-->#}
                    {#                    <div class="row notification-li read-li">#}
                    {#                        <div class="col-xs-8"><label class="wiki-notification"><i class="fa fa-commenting"></i> | ОТВЕТ | DEV_ADMIN | 13.09.2016</label> (Прочитано)</div>#}
                    {#                        <div class="col-xs-4 text-right"><label><i class="glyphicon glyphicon-alert problem"></i> <i class="glyphicon glyphicon-remove delete"></i></label></div>#}
                    {#                    </div>#}
                    {##}
                    {##}
                    {#                    <!--Экземпляр уведомления-->#}
                    {#                    <div class="row notification-li read-li">#}
                    {#                        <div class="col-xs-8"><label class="wiki-notification"><i class="glyphicon glyphicon-exclamation-sign"></i> | ПРЕДУПРЕЖДЕНИЕ | DEV_ADMIN | 13.09.2016</label> (Прочитано)</div>#}
                    {#                        <div class="col-xs-4 text-right"><label><i class="glyphicon glyphicon-alert problem"></i> <i class="glyphicon glyphicon-remove delete"></i></label></div>#}
                    {#                    </div>#}
                    {##}
                    {#                    <!--Экземпляр уведомления-->#}
                    {#                    <div class="row notification-li read-li">#}
                    {#                        <div class="col-xs-8"><label class="wiki-notification"><i class="glyphicon glyphicon-exclamation-sign"></i> | ВНИМАНИЕ | DEV_ADMIN | 13.09.2016</label> (Прочитано)</div>#}
                    {#                        <div class="col-xs-4 text-right"><label><i class="glyphicon glyphicon-alert problem"></i> <i class="glyphicon glyphicon-remove delete"></i></label></div>#}
                    {#                    </div>#}
                    {##}
                    {#                    <!--Экземпляр уведомления-->#}
                    {#                    <div class="row notification-li read-li">#}
                    {#                        <div class="col-xs-8"><label class="wiki-notification"><i class="glyphicon glyphicon-bell"></i> | СОБЫТИЕ | DEV_ADMIN | 13.09.2016</label> (Прочитано)</div>#}
                    {#                        <div class="col-xs-4 text-right"><label><i class="glyphicon glyphicon-alert problem"></i> <i class="glyphicon glyphicon-remove delete"></i></label></div>#}
                    {#                    </div>#}
                </div>
                {#                <div class="container-fluid">#}
                {#                    <div class="row">#}
                {#                        <br>#}
                {#                    </div>#}
                {#                    <div class="row">#}
                {#                        <br>#}
                {#                    </div>#}
                {#                    <div class="row">#}
                {#                        <div class="col-xs-6"><a href="" id="wiki-style-btn" class="btn"><i class="glyphicon glyphicon-menu-left"></i> Предыдущие</a></div>#}
                {#                        <div class="col-xs-6 text-right"><a href="" id="wiki-style-btn" class="btn">Следующие <i class="glyphicon glyphicon-menu-right"></i></a></div>#}
                {#                    </div>#}
                {#                    <div class="row">#}
                {#                        <br>#}
                {#                    </div>#}
                {#                    <div class="row">#}
                {#                        <br>#}
                {#                    </div>#}
                {#                </div>#}
            </div>
        </div>
    </div>

    <!-- Модальное окно открывающее уведомление -->
    <div class="modal fade" id="modal_notification" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="notification-header">Уведомление</h4>
                </div>
                <input hidden id="notification-global-nickname">
                <input hidden id="notification-global-date">
                <div class="modal-body text-left">
                    <div id="wiki-message-notification" style="display: none;">
                        <label>Получено от </label> <a id="notification-message-author"></a>
                        <br>
                        <label>Дата отправки: </label> <span id="notification-message-date"></span>
                        <br>
                        <label>Сообщение:</label>
                        <h5 id="notification-message-text"></h5>
                        <hr>
                        <a id="" class="btn btn-link">Ответить</a>
                        <a id="" class="btn btn-link">Пожаловаться</a>
                    </div>

                    <div id="wiki-comment-notification" style="display: none;">
                        <label>Дата отправки: </label> <span id="notification-date"></span>
                        <br>
                        <label>Конспект: </label> <span id="notification-theme"></span>
                        <br>
                        <label>Сообщение:</label>
                        <h5 id="notification-text"></h5>
                        <hr>
                        <a href="" id="" class="btn btn-link">Ответить</a>
                        <a href="" id="" class="btn btn-link">Удалить собщение</a>
                        <a href="" id="" class="btn btn-link">Пожаловаться</a>
                    </div>

                    <div id="wiki-invite-notification" style="display: none;">
                        <label>Пользователь</label> <a id="notification-user-invite"></a>
                        <br>
                        <label>Хочет добавить Вас в коллеги</label>
                        <br>
                        <label>Дата отправки: </label> <span id="notification-date-invite"></span>
                        <hr>
                        <a id="add_colleague_invite" class="btn btn-link">Добавить в коллеги</a>
                        <a id="" class="btn btn-link">Пожаловаться</a>
                    </div>

                    <div id="wiki-send-message-notification" style="display: none;">
                        <label>Отправлено пользователю </label> <a id="notification-send-author"></a>
                        <br>
                        <label>Дата отправки: </label> <span id="notification-send-date"></span>
                        <br>
                        <label>Текст письма: </label>
                        <br>
                        <span id="notification-send-text"></span>
                        <hr>
                    </div>


                </div>
                <div class="modal-footer">
                    <button id="wiki-style-btn-remove-notification" type="button" class="btn" data-dismiss="modal">Удалить это уведомление</button>
                    <button id="wiki-style-btn" type="button" class="btn" data-dismiss="modal">Назад</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block add_script %}
    {% load staticfiles %}
    <link href={% static "wiki/wiki_styles/notifications.css" %} type="text/css" rel="stylesheet">
    <script src={% static "wiki/wiki_scripts/notifications.js" %}></script>
    <script>
        {% for notification in notifications %}
            $("#wiki-notification-{{ notification.number|escapejs }}").click(function () {
                $("#notification-global-nickname").val("{{ notification.nickname|escapejs }}");
                $("#notification-global-date").val("{{ notification.date|escapejs }}");
                {% if notification.type == "message" %}
                    //ЕСЛИ ЭТО СООБЩЕНИЕ
                    //Установка заголовка
                    $("#notification-header").text("Входящее письмо");
                    $("#wiki-message-notification").attr("style","");
                    $("#wiki-send-message-notification").attr("style","display:none;");
                    $("#wiki-comment-notification").attr("style","display:none;");
                    $("#wiki-invite-notification").attr("style","display:none;");
                    //Установка отправителя
                    $("#notification-message-author").text("{{ notification.nickname|escapejs }}");
                    $("#notification-message-author").attr("href","/user/"+{{ notification.id|escapejs }});
                    //Установка даты
                    $("#notification-message-date").text("{{ notification.date|escapejs }}");
                    //Установка текста
                    $("#notification-message-text").text("{{ notification.message|escapejs }}");
                {% elif notification.type == "sended message" %}
                    //ЕСЛИ ЭТО ОТПРАВЛЕННОЕ СООБЩЕНИЕ
                    //Установка заголовка
                    $("#notification-header").text("Отправленное письмо");
                    $("#wiki-send-message-notification").attr("style","");
                    $("#wiki-message-notification").attr("style","display:none;");
                    $("#wiki-comment-notification").attr("style","display:none;");
                    $("#wiki-invite-notification").attr("style","display:none;");
                    //Установка получателя
                    $("#notification-send-author").text("{{ notification.nickname|escapejs }}");
                    $("#notification-send-author").attr("href","/user/"+{{ notification.id|escapejs }});
                    //Установка даты
                    $("#notification-send-date").text("{{ notification.date|escapejs }}");
                    //Установка текста
                    $("#notification-send-text").text("{{ notification.message|escapejs }}");
                {% elif notification.type == "invite_colleagues" %}
                    //ЕСЛИ ЭТО ЗЯВКА
                    //Установка заголовка
                    $("#notification-header").text("Заявка в коллеги");
                    $("#wiki-invite-notification").attr("style","");
                    $("#wiki-message-notification").attr("style","display:none;");
                    $("#wiki-comment-notification").attr("style","display:none;");
                    $("#wiki-send-message-notification").attr("style","display:none;");
                    //Установка даты
                    $("#notification-date-invite").text("{{ notification.date|escapejs }}");
                    //Установка пользователя
                    $("#notification-user-invite").text("{{ notification.nickname|escapejs }}");
                    $("#notification-user-invite").attr("href","/user/"+{{ notification.id|escapejs }});
                {% endif %}
                {% if not notification.is_read %}
                    //Выполняем POST запрос, который делает уведомление прочитанным
                    $.ajax({
                        type: "POST",
                        url: "read_notification/",
                        data:{
                            'nickname':''+"{{ notification.nickname|escapejs }}",
                            'date':''+"{{ notification.date|escapejs }}",
                        },
                        dataType: "text",
                        cache: false,
                        success: function(data){
                            if (data == 'ok'){
                                $("#wiki-notification-{{ notification.number|escapejs }}").attr("style","padding-top: 5px;margin-top: 5px;border: 1px solid #b5b5b5;box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.16), 0 2px 5px 0 rgba(0, 0, 0, 0.12);background-color: #ffffff;border-radius: 0px;transition: all 0.5s ease 0s;opacity: 0.6;background-color: #ffffff;font-size: 12px;");
                            }
                        }
                    });
                {% endif %}
            });

        {% endfor %}
    </script>
{% endblock %}