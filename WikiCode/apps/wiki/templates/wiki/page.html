<!--
    Copyright (C) 2016 Igor Soloduev <diahorver@gmail.com>

    This file is part of WikiCode.

    WikiCode is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    WikiCode is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with WikiCode.  If not, see <http://www.gnu.org/licenses/>.
-->
{% extends 'main.html' %}
{% load bootstrap3 %}
{% block page_name %}
    <div class="container" style="margin-top: 50px;" xmlns="http://www.w3.org/1999/html">
        <div class="row">
            <br>
        </div>
    </div>
    <div class="container">
        <div class="row">
        </div>
    </div>
{% endblock %}
{% block content %}
    {% load staticfiles %}

    <div id="sb-site">
        <div class="container" id="main-block">
            <div class="row">
                <div class="container">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-12"
                             style="border: 1px solid #d5d5d5;min-height:105px;border-bottom: none;">
                            <div class="row">
                                <label class="text-center btn-primary btn-block wikicode-theme-header">{{ publication.title|upper }}</label>
                            </div>
                            <div class="row">
                                <br>
                                <div class="col-md-6 col-xs-12">
                                    <div class="container-fluid text-left">
                                        <div class="row">
                                            <a id="wikicode-name-author" href="/user/{{ publication.id_author }}" class="btn"><span class="glyphicon glyphicon-user"></span>{{ publication.nickname_author }}</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-xs-12">
                                    <div class="container-fluid text-right">
                                        <div class="row">
                                            <div class="btn-group">
                                                <a id="wikicode-up-right-button" class="btn"><span class="glyphicon glyphicon-thumbs-up"></span> (0)</a>
                                                <a id="wikicode-up-right-button" class="btn"><span class="glyphicon glyphicon-import"></span> (0)</a>
                                                <a id="wikicode-up-right-button" class="btn"><span class="glyphicon glyphicon-download"></span> (0)</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <div class="tabbable-panel" style="border-bottom: 0px solid #000000; border-top: 0px solid black;">
                                    <div class="tabbable-pills">
                                        <ul class="nav nav-tabs" style="border-bottom: none;">
                                            <li class="active"><a href="#tab_default_1" data-toggle="tab" id="wiki-publ-tab-1">Конспект </a></li>
                                            <li><a href="#tab_default_3" data-toggle="tab" id="wiki-publ-tab-2">Оглавление </a></li>
                                            <li><a href="#tab_default_4" data-toggle="tab" id="wiki-publ-tab-3">Файлы </a></li>
                                            <li><a href="#tab_default_5" data-toggle="tab" id="wiki-publ-tab-4">Ссылки </a></li>
                                            <li><a href="#tab_default_6" data-toggle="tab" id="wiki-publ-tab-5">Версии </a></li>
                                            <li><a href="#tab_default_7" data-toggle="tab" id="wiki-publ-tab-6">Настройки </a></li>
                                        </ul>
                                        <div class="tab-content">
                                            <div class="tab-pane active" id="tab_default_1">
                                                <div class="col-xs-12 col-sm-12 col-md-12"
                                                     style="border: 1px solid #d5d5d5;">
                                                    <div class="row">
                                                        <ul class="border" id="row-paragraphs">
                                                            {% if module_dynamic_paragraphs %}
                                                                {% for elem in numbers %}
                                                                    <li id="li-md-wikicode-{{ elem }}" class="task" data-id="{{ elem }}">
                                                                        <div class="md-hover" id="markdown-row-{{ elem }}"></div>
                                                                    </li>
                                                                {% endfor %}
                                                            {% else %}
                                                                {% for elem in numbers %}
                                                                    <li id="li-md-wikicode-{{ elem }}">
                                                                        <div class="md-hover" id="markdown-row-{{ elem }}"></div>
                                                                    </li>
                                                                {% endfor %}
                                                            {% endif %}
                                                        </ul>
                                                    </div>
                                                </div>
                                                {% if module_main_comments %}
                                                    <div class="col-xs-12" id="show-comment-btn">
                                                        <div class="row text-center">
                                                            <br>
                                                            <button id="btn-show-comment" class="btn btn-link btn-show-comment"><i class="fa fa-arrow-down" aria-hidden="true"></i> Показать комментарии <i class="fa fa-arrow-down" aria-hidden="true"></i></button>
                                                            <br>
                                                            <br>
                                                        </div>
                                                    </div>
                                                    <div class="col-xs-12" id="hide-comment-btn" hidden>
                                                        <div class="row text-center">
                                                            <br>
                                                            <button id="btn-hide-comment" class="btn btn-link btn-show-comment"><i class="fa fa-arrow-up" aria-hidden="true"></i> Скрыть комментарии <i class="fa fa-arrow-up" aria-hidden="true"></i></button>
                                                            <br>
                                                            <br>
                                                        </div>
                                                    </div>
                                                    <!-- БЛОК ОБЩИХ КОММЕНТАРИЕВ ПРИМЕР -->
                                                    <div class="col-xs-12" id="main-comments-block" hidden>
                                                        <div class="row">
                                                            <div class="comments">
                                                                {% if main_comments_count > 0 %}
                                                                    <h3>Комментарии ({{ main_comments_count }})</h3>
                                                                    {{ main_comments|safe }}
                                                                {% else %}
                                                                    <h4 class="text-center">Комментариев нет. Станьте первым!</h4>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        {% if user_data != "None" %}
                                                            <div class="row text-center">
                                                                <hr>
                                                                <br>
                                                                <button id="wiki-style-btn-send-main-comment" data-toggle="modal" data-target="#modal_main_comment" class="btn">Оставить комментарий</button>
                                                                <br>
                                                                <br>
                                                            </div>
                                                        {% else %}
                                                            <div class="row text-center">
                                                                <hr>
                                                                <br>
                                                                <span style="font-size: 14px; color: rgba(82, 82, 82, 0.44)">Войдите или зарегистрируйтесь, чтобы оставить комментарий</span>
                                                                <br>
                                                                <br>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% else  %}
                                                    <div class="col-xs-12">
                                                        <div class="row">
                                                            <br>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="tab-pane" id="tab_default_3">
                                                <div class="col-xs-12 col-sm-12 col-md-12"
                                                     style="border: 1px solid #d5d5d5;">
                                                    <div class="row text-center">
                                                        <h4>Здесь будет сгенерировано оглавление</h4><br><br><br><br>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tab-pane" id="tab_default_4">
                                                <div class="col-xs-12 col-sm-12 col-md-12"
                                                     style="border: 1px solid #d5d5d5;">
                                                    <div class="row text-center">
                                                        <h4>Здесь будут располагаться прикрепленные файлы</h4><br><br><br><br>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tab-pane" id="tab_default_5">
                                                <div class="col-xs-12 col-sm-12 col-md-12"
                                                     style="border: 1px solid #d5d5d5;">
                                                    <div class="row text-center">
                                                        <h4>Здесь будут перечислены найденные ссылки в конспекте</h4><br><br><br><br>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tab-pane" id="tab_default_6">
                                                <div class="col-xs-12 col-sm-12 col-md-12"
                                                     style="border: 1px solid #d5d5d5;">
                                                    <div class="row text-center">
                                                        <h4>Здесь можно будет переключать версии конспекта</h4><br><br><br><br>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tab-pane" id="tab_default_7">
                                                <div class="col-md-5 col-sm-5 col-xs-12">
                                                    <br>
                                                    <div class="row">
                                                        <a href="/publ_manager/{{ publication.id_publication }}"  class="btn btn-block" id="wiki-style-btn">Панель управления конспектом</a>
                                                    </div>
                                                    <br>
                                                </div>
                                                <div class="col-md-2 col-sm-2 col-xs-0"></div>
                                                <div class="col-md-5 col-sm-5 col-xs-12">
                                                    <br>
                                                    <div class="row">
                                                        <button class="btn btn-block" id="wiki-style-btn">Тема оформления конспекта</button>
                                                    </div>
                                                    <br>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button class="btn-lg" id="pollSlider-button"><span class="glyphicon glyphicon-folder-close"></span> </button>
    <button class="btn-lg" id="like-pollSlider-button"><span class="glyphicon glyphicon-thumbs-up"></span> </button>
    <button class="btn-lg" id="contents-pollSlider-button"><span class="glyphicon glyphicon-bookmark"></span> </button>
    <div id="wiki-left-page" class="sb-slidebar sb-left sb-width-custom">
        <br><br><br><br><br>
        <label class="btn-block btn-primary text-center">КОНСПЕКТЫ {{ publication.nickname_author|upper }}</label>
        {% if preview_tree == "NONE" %}
            <div class="col-xs-12 text-center">
                <label>Дерево отсутствует</label>
            </div>
        {% else %}
            <ul id="tree2">
                <!--Здесь должен располагаться сгенерированный html preview дерева-->
                {{ preview_tree|safe }}
            </ul>
        {% endif %}
    </div>

    {% if module_dynamic_paragraphs %}
        <!--Контекстное меню для абзацев-->
        <nav id="context-menu" class="context-menu">
            <ul class="context-menu__items">
                <li id="lt-context-menu-1" class="context-menu__item"><a id="comment_paragraph_wiki_tree_context" data-toggle="modal" data-target="#modal_dynamic_comment" class="context-menu__link" data-action="Comment" style="text-decoration: none;"><i class="fa fa-comment"></i> Комментировать</a></li>
                <li id="lt-context-menu-2" class="context-menu__item"><a id="edit_paragraph_wiki_tree_context" class="context-menu__link" data-action="Edit" style="text-decoration: none;"><i class="fa  fa-pencil-square-o"></i> Редактировать</a></li>
                <li id="lt-context-menu-3" class="context-menu__item"><a id="error_paragraph_wiki_tree_context" data-toggle="modal" data-target="#modal_develop_func" class="context-menu__link" data-action="Error" style="text-decoration: none;"><i class="fa fa-exclamation-triangle"></i> Указать на ошибку</a></li>
                <li id="lt-context-menu-4" class="context-menu__item"><a id="copy_paragraph_wiki_tree_context" data-toggle="modal" data-target="#modal_develop_func" class="context-menu__link" data-action="Copy" style="text-decoration: none;"><i class="fa fa-clone"></i> Копировать</a></li>
            </ul>
        </nav>
        <!--Выбранный номер параграфа. Заполняется в скрипте отвечающим за контекстное меню-->
        <input hidden value="" id="selected_number_paragraph">
        <!--Модальное окно для динамического комментирования абзаца-->
        <div class="modal fade" id="modal_dynamic_comment" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">Комментирование параграфа</h4>
                    </div>
                    <div class="modal-body">
                        <div class="" id="md-dynamic-paragraph-show"></div>
                        <hr>
                        <h4>Комментарии:</h4>
                        <!-- Сюда должны вставляться комментарии -->
                        <div id="dynamic-comments-div"></div>
                        {% if user_data == "None" %}
                            <hr>
                            <div class="row">
                                <div class="col-xs-12 text-center">
                                    <span style="font-size: 12px; color: rgba(82, 82, 82, 0.44)">Войдите или зарегистрируйтесь, чтобы оставить комментарий</span>
                                </div>
                            </div>
                        {% else %}
                            <hr>
                            <div class="row">
                                <div class="col-xs-12">
                                    <textarea type="text" rows="2" class="form-control btn-block" id="wiki-dynamic-comment-field" name="" placeholder="Ваш комментарий..." autofocus style="border-radius: 0px; resize: none;"></textarea>
                                    <br>
                                </div>
                                <div class="col-xs-8"></div>
                                <div class="col-xs-4">
                                    <button type="button" id="wiki-btn-send-dynamic-comment" class="btn btn-block" name="">Отправить</button>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% if module_main_comments %}
        <!--Выбранный id пользователя, которому идет ответ. Заполняется в главном скрипте для этой страницы -->
        <input hidden value="" id="reply_id_user">
        <!--Модальное окно для общего комментирования-->
        <div class="modal fade" id="modal_main_comment" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">Добавить комментарий</h4>
                    </div>
                    <div class="modal-body">
                        <h4>Введите текст комментария:</h4>
                        <div class="row">
                            <div class="col-xs-12">
                                <textarea type="text" rows="8" class="form-control btn-block" id="wiki-main-comment-field" name="" placeholder="Ваш комментарий..." autofocus style="border-radius: 0px; resize: none;"></textarea>
                                <br>
                            </div>
                            <div class="col-xs-8"></div>
                            <div class="col-xs-4">
                                <button type="button" id="wiki-btn-send-main-comment" class="btn btn-block" name="">Отправить</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% load staticfiles %}
    <script type="text/javascript" src="{% static 'wiki/highlight/highlight.pack.js'%}"></script>
    <script>hljs.initHighlightingOnLoad();</script>
{% endblock %}

{% block add_script %}
    {% load staticfiles %}
    <script src={% static "wiki/jsTree/jstree.min.js"%}></script>
    <link href={% static "wiki/jsTree/themes/default/style.min.css"%} rel="stylesheet" >
    <link href={% static "wiki/wiki_styles/page_themes/default.css" %} type="text/css" rel="stylesheet">
    <link href={% static "wiki/wiki_styles/page.css" %} type="text/css" rel="stylesheet">
    <link href={% static "wiki/slidebars/styles/slidebars.min.css" %} type="text/css" rel="stylesheet">
    <script src={% static "wiki/wiki_scripts/page.js" %}></script>
    {% if module_dynamic_paragraphs %}
        <script src={% static "wiki/wiki_scripts/page_context.js" %}></script>
    {% endif %}
    <script src={% static "wiki/slidebars/scripts/slidebars.min.js" %}></script>
    <script>
        $(init);

        //Текущая тема оформления
        var current_theme = "Default";
        var theme_border_style;
        if(current_theme == "United") {
            theme_border_style = "padding: 3px 20px;border-right: 3px solid #f76e2f;background-color: #F1F1F1;transition: all 0.5s ease 0s;";
        }
        else if(current_theme == "Monokai") {
            theme_border_style = "padding: 3px 20px;border-right: 3px solid #ea397e;background-color: #54554E;transition: all 0.5s ease 0s;";
        }
        else if(current_theme == "Default") {
            theme_border_style = "padding: 3px 20px;border-right: 3px solid #225a84;background-color: #F1F1F1;transition: all 0.5s ease 0s;";
        }

        //Номер выбранного параграфа
        //В этом массиве будет хранится разбитый на параграфы маркдаун текст.
        var md_text = [];
        {% for p in paragraphs %}
            md_text[{{ p.index|escapejs }}] = '{{ p.text|escapejs }}';
            document.getElementById('markdown-row-{{ p.index|escapejs }}').innerHTML = marked(md_text[{{ p.index|escapejs }}]);
            document.getElementById('li-md-wikicode-{{ p.index|escapejs }}').onmousemove = function(e) {
                $("#markdown-row-{{ p.index|escapejs }}").attr("style", theme_border_style);
            };
            document.getElementById('li-md-wikicode-{{ p.index|escapejs }}').onmouseout = function(e) {
                $(".border li .md-hover").attr("style", "padding: 3px 20px;border-right: 3px solid #c9c9c9;");
            };
        {% endfor %}


        // Если активирован модуль динамических комментариев, то выполняем их обработку
        {% if module_dynamic_paragraphs %}
            // Если произошло нажатие на кнопку комментировать абзац
            $("#comment_paragraph_wiki_tree_context").on("click", function () {
                var selected_num_paragraph = parseInt($("#selected_number_paragraph").val());
                // Перед тем как добавлять блоки html кода, очищаем предыдущие добавленные
                $("#dynamic-comments-div").empty();
                // Добавляем в модальное окно сам текст абзаца
                document.getElementById('md-dynamic-paragraph-show').innerHTML = marked(md_text[selected_num_paragraph]);
                // Для удобства, разбиваем весь добавляемый html код на части
                var html_dynamic_comment_part_1 = '<div class="dynamic-comment-block"><div class="row"><div class="col-xs-8 text-left"><a href=';
                var html_dynamic_comment_part_1_1 = ' style="text-decoration: none;"><b>';
                var html_dynamic_comment_part_2 = '</b></a></div><div class="col-xs-4 text-right"><b><i><span style="font-size: 12px; color: rgba(82, 82, 82, 0.44);"><i class="fa fa-exclamation-triangle" aria-hidden="true"> </i></span></i></b></div></div><div class="row"><div class="col-xs-12 text-left">';
                var html_dynamic_comment_part_3 = '</div></div><div class="row"><div class="col-xs-4 text-left"><b><i><span style="font-size: 12px; color: rgba(82, 82, 82, 0.44);">';
                var html_dynamic_comment_part_4 = '</span></i></b></div><div class="col-xs-8 text-right"><a href="#" style="text-decoration: none;"><b><i>Полезно <span style="font-size: 12px;"><i class="fa fa-thumbs-up" aria-hidden="true"></i></span> (';
                var html_dynamic_comment_part_5 = ')</i></b></a></div></div></div>';
                // Само добавление кода"/user/{{ publication.id_author }}"
                {% for comment in dynamic_comments %}
                    if(({{ comment.paragraph|escapejs }}) == selected_num_paragraph) {
                        $("#dynamic-comments-div").append(html_dynamic_comment_part_1+'"/user/{{ comment.id_author|escapejs }}"'+html_dynamic_comment_part_1_1+'{{ comment.name_author|escapejs }}'+html_dynamic_comment_part_2+'{{ comment.text|escapejs }}'+html_dynamic_comment_part_3+'{{ comment.date|escapejs }}'+html_dynamic_comment_part_4+'{{ comment.rating|escapejs }}'+html_dynamic_comment_part_5);}
                {% endfor %}
            });
        {% endif %}


        {% if module_main_comments %}
            /* Общий блок комментариев */
            $("#btn-show-comment").on("click", function () {
                $("#main-comments-block").show();
                $("#show-comment-btn").hide();
                $("#hide-comment-btn").show();
            });

            $("#btn-hide-comment").on("click", function () {
                $("#main-comments-block").hide();
                $("#show-comment-btn").show();
                $("#hide-comment-btn").hide();
            });
        {% endif %}

    </script>
{% endblock %}