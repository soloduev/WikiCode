<!--
    Copyright (C) 2016 Igor Soloduev <diahorver@gmail.com>

    This file is part of WikiCode.

    WikiCode is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    WikiCode is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with WikiCode.  If not, see <http://www.gnu.org/licenses/>.
-->
{% extends 'main.html' %}
{% load bootstrap3 %}
{% block page_name %}
    <div class="container" style="margin-top: 50px;" xmlns="http://www.w3.org/1999/html">
        <div class="row">
            <br>
        </div>
    </div>
    <div class="container">
        <div class="row">
        </div>
    </div>
{% endblock %}
{% block content %}
    <div id="sb-site">
        <div class="container" id="main-block">
            <div class="row">
                <div class="container">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-12"
                             style="border: 1px solid #d5d5d5;min-height:105px;border-bottom: none;">
                            <div class="row">
                                <label class="text-center btn-primary btn-block wikicode-theme-header">{{ publication.title|upper }}</label>
                            </div>
                            <div class="row">
                                <br>
                                <div class="col-md-6 col-xs-12">
                                    <div class="container-fluid text-left">
                                        <div class="row">
                                            <a id="wikicode-name-author" href="/user/{{ publication.id_author }}" class="btn"><span
                                                    class="glyphicon glyphicon-user"></span>
                                                {{ publication.nickname_author }}</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-xs-12">
                                    <div class="container-fluid text-right">
                                        <div class="row">
                                            <div class="btn-group">
                                                <a id="wikicode-like-publ" href="#" class="btn"><span
                                                        class="glyphicon glyphicon-thumbs-up"></span> ({{ publication.likes }})</a>

                                                <a id="wikicode-import-publ" href="#" class="btn"><span class="glyphicon glyphicon-import"></span> ({{ publication.imports }})</a>


                                                <a id="wikicode-download-publ" href="#" class="btn"><span
                                                        class="glyphicon glyphicon-download"></span> ({{ publication.downloads }})</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr>


                                <div class="tabbable-panel" style="border-bottom: 0px solid #000000; border-top: 0px solid black;">
                                    <div class="tabbable-pills">
                                        <ul class="nav nav-tabs" style="border-bottom: none;">
                                            <li class="active">
                                                <a href="#tab_default_1" data-toggle="tab">
                                                    Конспект </a>
                                            </li>
                                            <li>
                                                <a href="#tab_default_3" data-toggle="tab">
                                                    Оглавление </a>
                                            </li>
                                            <li>
                                                <a href="#tab_default_4" data-toggle="tab">
                                                    Файлы </a>
                                            </li>
                                            <li>
                                                <a href="#tab_default_5" data-toggle="tab">
                                                    Ссылки </a>
                                            </li>
                                            <li>
                                                <a href="#tab_default_6" data-toggle="tab">
                                                    Версии </a>
                                            </li>
                                            <li>
                                                <a href="#tab_default_7" data-toggle="tab">
                                                    Настройки </a>
                                            </li>
                                        </ul>
                                        <div class="tab-content">
                                            <div class="tab-pane active" id="tab_default_1">
                                                <div class="col-xs-12 col-sm-12 col-md-12"
                                                     style="border: 1px solid #d5d5d5;">
                                                    <div class="row">
                                                        <ul class="border" id="row-paragraphs">
                                                            {% for elem in numbers %}
                                                                <li id="li-md-wikicode-{{ elem }}">
                                                                    <div class="md-hover" id="markdown-row-{{ elem }}"></div>

                                                                </li>
                                                            {% endfor %}
                                                        </ul>

                                                    </div>
                                                </div>

                                                <div class="col-xs-12">
                                                    <div class="row">
                                                        <br>
                                                        <label for="comment">Ваш Комментарий</label>
                                                        <textarea id="add-comment-wiki-page" name="comment" class="form-control" rows="3" style="resize: none; border-radius: 0px;"></textarea>
                                                    </div>
                                                    <div class="row">
                                                        <br>
                                                        <button id="wiki-style-btn-add-comment"  type="submit" class="btn">Отправить</button>
                                                        <br>
                                                        <br>
                                                    </div>
                                                </div>

                                                <!--Блок отображения комментариев -->
                                                <div class="col-xs-12">
                                                    <div class="row">

                                                        {% for comment in all_comments reversed%}
                                                            <!--Экземпляр сообщения-->
                                                            <div class="comment-block-wiki">
                                                                <!--Имя автора комментария-->
                                                                <span class="text-left"><b><a href="/user/{{ comment.id_author }}" style="text-decoration: none;"> {{ comment.nickname_author }}</a></b> ({{ comment.data }}) <i class="fa fa-long-arrow-up">{{ comment.rating }}</i></span>
                                                                <!--Сообщение-->
                                                                <p>{{ comment.text }}</p>
                                                                <div class="btn-group"><div class="btn comment-btn-wiki" href="#" style="text-decoration: none;">Согласен <i class="fa fa-long-arrow-up"></i></div> <div class="btn comment-btn-wiki" href="#" style="text-decoration: none;">Не согласен <i class="fa fa-long-arrow-down"></i></div> <div class="btn comment-btn-wiki" href="#" style="text-decoration: none;"> Ответить <i class="fa fa-commenting-o"></i></div></div>
                                                                <p></p>
                                                            </div>
                                                        {% endfor %}


                                                        <br>
                                                        <br>
                                                        <h4>Просмотров(78) Комментариев(54) Понравилось(35) Сохранили к себе (9) Скачали (2) </h4>

                                                    </div>
                                                </div>

                                            </div>
                                            <div class="tab-pane" id="tab_default_3">
                                                <div class="col-xs-12 col-sm-12 col-md-12"
                                                     style="border: 1px solid #d5d5d5;">
                                                    <div class="row">

                                                        <h4>Здесь будет сгенерировано оглавление</h4>

                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tab-pane" id="tab_default_4">


                                            </div>
                                            <div class="tab-pane" id="tab_default_5">

                                            </div>
                                            <div class="tab-pane" id="tab_default_6">

                                            </div>
                                            <div class="tab-pane" id="tab_default_7">

                                                <div class="col-md-5 col-sm-5 col-xs-12">
                                                    <br>
                                                    <div class="row">
                                                        <a href="/publ_manager/{{ publication.id_publication }}"  class="btn btn-block" id="wiki-style-btn">
                                                            Панель управления конспектом
                                                        </a>
                                                    </div>
                                                    <br>
                                                </div>
                                                <div class="col-md-2 col-sm-2 col-xs-0">

                                                </div>
                                                <div class="col-md-5 col-sm-5 col-xs-12">
                                                    <br>
                                                    <div class="row">
                                                        <button class="btn btn-block" id="wiki-style-btn">
                                                            Тема оформления конспекта
                                                        </button>
                                                    </div>
                                                    <br>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button class="btn-lg" id="pollSlider-button"><span class="glyphicon glyphicon-tree-deciduous"></span> </button>
    <button class="btn-lg" id="like-pollSlider-button"><span class="glyphicon glyphicon-thumbs-up"></span> </button>
    <button class="btn-lg" id="info-pollSlider-button"><span class="glyphicon glyphicon-info-sign"></span> </button>
    <div id="wiki-left-page" class="sb-slidebar sb-left sb-width-custom">
        <br><br><br><br><br>
        <label class="btn-block btn-primary text-center">ДЕРЕВО ПОЛЬЗОВАТЕЛЯ</label>
        <ul id="tree2">
            <!--Здесь должно располгататься сгенерированное дерево пользователя -->
            {{ preview_tree|safe }}
        </ul>
    </div>

    <!--Выпадающее меню при нажатии на абзац-->
    <div id="context-dinamic-menu" style="display: none;">
        <ul id="wiki-style-btns-options">
            <li id="wiki-style-btn-option-1" class="btn" style="width: 35px;border-radius: 25px; padding-left: 10px;"><i class="fa fa-pencil"></i></li>
            <li id="wiki-style-btn-option-2" class="btn" data-toggle="modal" data-target="#modal_add_error" style="width: 35px;border-radius: 25px; padding-left: 10px;"><i class="fa fa-exclamation-triangle"></i></li>
            <li id="wiki-style-btn-option-3" class="btn" data-toggle="modal" data-target="#modal_chat" style="width: 35px;border-radius: 25px; padding-left: 10px;"><i class="fa fa-comment-o"></i></li>
        </ul>
    </div>

    <!-- Модальное окно для указания на ошибку -->
    <div class="modal fade" id="modal_add_error" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">Нашли ошибку в параграфе? Сообщите автору!</h4>
                </div>
                <div class="modal-body">
                    <div id="paragraph_input_error"></div>
                    <hr>
                    <label><h4>Опишите ошибку:</h4></label>
                    <textarea class="form-control" style="resize: none; border-radius: 0px; font-family: Courier;" rows="6" placeholder="Опишите найденную Вами ошибку/неточность и прочее..."></textarea>
                </div>
                <div class="modal-footer">
                    <button id="wiki-style-btn" type="button" class="btn" data-dismiss="modal">Отмена</button>
                    <button id="wiki-style-btn"type="button" class="btn">Добавить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для сообщений к конкретному абзацу -->
    <div class="modal fade" id="modal_chat" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">Комментирование параграфа</h4>
                </div>
                <div class="modal-body">
                    <div id="paragraph_input_comment"></div>
                    <hr>
                    <!--Экземпляр сообщения-->
                    <div class="micro-comment-block-wiki">

                        <!--Имя автора комментария-->
                        <span class="text-left"><b><a href="" style="text-decoration: none;"> Vasya</a></b> (17.07.2016 13:45:36)</span>
                        <!--Сообщение-->
                        <p>А как это вообще работает?</p>
                        <p></p>
                    </div>
                    <!--Экземпляр сообщения-->
                    <div class="micro-comment-block-wiki">

                        <!--Имя автора комментария-->
                        <span class="text-left"><b><a href="" style="text-decoration: none;"> Petya</a></b> (17.07.2016 13:45:36)</span>
                        <!--Сообщение-->
                        <p>Молча</p>
                        <p></p>
                    </div>
                    <!--Экземпляр сообщения-->
                    <div class="micro-comment-block-wiki">

                        <!--Имя автора комментария-->
                        <span class="text-left"><b><a href="" style="text-decoration: none;"> Petya</a></b> (17.07.2016 13:45:36)</span>
                        <!--Сообщение-->
                        <p>Какой то комментарий...Какой то комментарий...Какой то комментарий...Какой то комментарий...Какой то комментарий...Какой то комментарий...</p>
                        <p></p>
                    </div>
                    <hr>
                    <label><h4>Ваш комментарий:</h4></label>
                    <textarea class="form-control" style="resize: none; border-radius: 0px; font-family: Courier;" rows="3" placeholder="Ваш комментарий..."></textarea>
                </div>
                <div class="modal-footer">
                    <button id="wiki-style-btn" type="button" class="btn" data-dismiss="modal">Отмена</button>
                    <button id="wiki-style-btn" type="button" class="btn">Добавить</button>
                </div>
            </div>
        </div>
    </div>
    {% load staticfiles %}
    <link rel="stylesheet" href="{% static 'wiki/highlight/styles/github.css'%}">
    <script type="text/javascript" src="{% static 'wiki/highlight/highlight.pack.js'%}"></script>
    <script>hljs.initHighlightingOnLoad();</script>
{% endblock %}

{% block add_script %}
    {% load staticfiles %}
    <link href={% static "wiki/wiki_styles/page.css" %} type="text/css" rel="stylesheet">
    <link href={% static "wiki/wiki_styles/page_themes/deafault.css" %} type="text/css" rel="stylesheet">
    <link href={% static "wiki/slidebars/styles/slidebars.min.css" %} type="text/css" rel="stylesheet">
    <script src={% static "wiki/wiki_scripts/page.js" %}></script>
    <script src={% static "wiki/slidebars/scripts/slidebars.min.js" %}></script>
    <script>
        $(init);

        //Текущая тема оформления
        var current_theme = "Default";
        var theme_border_style;
        if(current_theme == "United")
        {
            theme_border_style = "padding: 3px 20px;border-right: 3px solid #f76e2f;background-color: #F1F1F1;transition: all 0.5s ease 0s;";
        }
        else if(current_theme == "Monokai")
        {
            theme_border_style = "padding: 3px 20px;border-right: 3px solid #ea397e;background-color: #54554E;transition: all 0.5s ease 0s;";
        }
        else if(current_theme == "Default")
        {
            theme_border_style = "padding: 3px 20px;border-right: 3px solid #225a84;background-color: #F1F1F1;transition: all 0.5s ease 0s;";
        }

        //Номер выбранного параграфа
        var num_paragraph =  "";
        var md_text = [];
        li_is_moved = false;
        var selectText = "";
        var isEdit = false;
        {% for p in paragraphs %}

            md_text[{{ p.index|escapejs }}] = '{{ p.text|escapejs }}';
            document.getElementById('markdown-row-{{ p.index|escapejs }}').innerHTML = marked(md_text[{{ p.index|escapejs }}]);


            document.getElementById('li-md-wikicode-{{ p.index|escapejs }}').onmousemove = function(e) {
                var div = document.getElementById('li-md-wikicode-{{ p.index|escapejs }}');
                var rect = div.getBoundingClientRect();
                var x = e.offsetX==undefined?e.layerX:e.offsetX;
                var y = e.offsetY==undefined?e.layerY:e.offsetY;
                if(!isEdit)
                {
                    num_paragraph = ""+{{ p.index|escapejs }};
                    $("#markdown-row-{{ p.index|escapejs }}").attr("style", theme_border_style);
                    li_is_moved = true;
                    $("#context-dinamic-menu").attr("style", "position: fixed;opacity: 1; right:"+(rect.right-rect.width-18)+"px; top:"+(rect.top+rect.height/2-20)+"px; z-index: 9999;transition: all 0.5s ease 0s;");
                }
                else
                {
                    $(".border li .md-hover").attr("style", "padding: 3px 20px;border-right: 3px solid #c9c9c9;transition: all 0.5s ease 0s;;");
                    li_is_moved = false;
                }
            };

            document.getElementById('li-md-wikicode-{{ p.index|escapejs }}').onmouseout = function(e) {
                $(".border li .md-hover").attr("style", "padding: 3px 20px;border-right: 3px solid #c9c9c9;transition: all 0.5s ease 0s;");
                li_is_moved = false;
            };



        {% endfor %}



        function selectChange() {
            selectText = $("#dynamic-paragraph").val();
        };

        //Динамическое редактирование
        $("#wiki-style-btn-option-1").on("click", function () {

            isEdit = true;
            //Получаем все необходимые данные с абазаца
            var height = $('#li-md-wikicode-'+num_paragraph+'').css('height');
            selectText = md_text[parseInt(num_paragraph)];

            //Заменяем элемент списка на input
            $("#markdown-row-"+num_paragraph+"")
                    .replaceWith(
                            '<textarea class="form-control dyn-par" id="dynamic-paragraph"' +
                            'onKeyUp="selectChange()"' +
                            'style="height:'+height+';' +
                            '">' +
                            selectText +
                            '</textarea>');
            $(".dyn-par").focus();

            //Как только теряем фокус:
            $("#dynamic-paragraph").blur(function (e) {

                //Применяем все и возвращаем все обратно
                $("#dynamic-paragraph").replaceWith(
                        '<div class="md-hover" id="markdown-row-'+num_paragraph+'"></div>'
                );
                document.getElementById('markdown-row-'+num_paragraph).innerHTML = marked(selectText);
                md_text[parseInt(num_paragraph)] = selectText;
                isEdit = false;
            });
        });

        $(document).mouseup(function()
        {
            $("#context-dinamic-menu").hide();
        });

        $(document).mouseleave(function () {
            $("#context-dinamic-menu").hide();
        });

        $(document).scroll(function () {
            $("#context-dinamic-menu").hide();
        });

        $(window).resize(function () {
            $("#context-dinamic-menu").hide();
        });



        $("#wiki-style-btn-option-2").on('click', function () {
            document.getElementById('paragraph_input_error').innerHTML = marked(md_text[num_paragraph]);
        });

        $("#wiki-style-btn-option-3").on('click', function () {
            document.getElementById('paragraph_input_comment').innerHTML = marked(md_text[num_paragraph]);
        });

        //То что касается тегов
        $(function() {
            $('#publ-tags').tags({
                readOnly: true,
                tagData:["c++", "beginning"],
            });
        });
    </script>
{% endblock %}